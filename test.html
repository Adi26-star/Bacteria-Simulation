<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ü¶† Super Bacteria Lab! üß™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Chewy&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #FFE5F1;
  --bg-secondary: #FFF0F8;
  --accent-purple: #9D4EDD;
  --accent-pink: #FF6BB5;
  --accent-green: #06D6A0;
  --accent-yellow: #FFD60A;
  --accent-blue: #4CC9F0;
  --accent-orange: #FF9F1C;
  --text-dark: #2D1B69;
  --shadow-color: rgba(157, 78, 221, 0.3);
  --card-bg: rgba(255, 255, 255, 0.9);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Fredoka', cursive;
  background: linear-gradient(135deg, #FFE5F1 0%, #E0BBE4 50%, #B4E7FF 100%);
  background-attachment: fixed;
  color: var(--text-dark);
  text-align: center;
  padding: 20px;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(255, 107, 181, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(76, 201, 240, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(157, 78, 221, 0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 950px;
  margin: auto;
  position: relative;
  z-index: 1;
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

h1 {
  font-family: 'Chewy', cursive;
  font-size: 3.5rem;
  color: var(--accent-purple);
  text-shadow:
    4px 4px 0px var(--accent-pink),
    6px 6px 0px rgba(157, 78, 221, 0.3);
  margin-bottom: 10px;
  letter-spacing: 2px;
  animation: bounce 2s infinite ease-in-out;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-10px) scale(1.02); }
}

.subtitle {
  font-size: 1.3rem;
  color: var(--text-dark);
  font-weight: 500;
  margin-bottom: 25px;
  padding: 12px 24px;
  background: var(--card-bg);
  border-radius: 50px;
  display: inline-block;
  border: 4px solid var(--accent-purple);
  box-shadow: 0 6px 0 var(--accent-purple), 0 10px 20px var(--shadow-color);
  animation: slideIn 0.6s ease-out 0.2s both;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.legend {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin: 20px 0;
  padding: 20px;
  background: var(--card-bg);
  border-radius: 25px;
  font-size: 16px;
  font-weight: 600;
  border: 5px solid var(--accent-blue);
  box-shadow: 0 8px 0 var(--accent-blue), 0 12px 25px var(--shadow-color);
  animation: slideIn 0.6s ease-out 0.3s both;
}

.legend > div {
  padding: 8px 16px;
  background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
  border-radius: 20px;
  border: 3px solid var(--text-dark);
  box-shadow: 3px 3px 0 var(--text-dark);
  transition: transform 0.2s, box-shadow 0.2s;
  animation: popIn 0.4s ease-out backwards;
}

.legend > div:nth-child(1) { animation-delay: 0.4s; }
.legend > div:nth-child(2) { animation-delay: 0.5s; }
.legend > div:nth-child(3) { animation-delay: 0.6s; }
.legend > div:nth-child(4) { animation-delay: 0.7s; }

@keyframes popIn {
  0% {
    opacity: 0;
    transform: scale(0);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.legend > div:hover {
  transform: translateY(-3px) rotate(-2deg);
  box-shadow: 5px 5px 0 var(--text-dark);
}

.controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
  padding: 25px;
  background: var(--card-bg);
  border-radius: 25px;
  border: 5px solid var(--accent-green);
  box-shadow: 0 8px 0 var(--accent-green), 0 12px 25px var(--shadow-color);
  animation: slideIn 0.6s ease-out 0.4s both;
}

.control-group {
  background: linear-gradient(135deg, #FFFFFF 0%, #F0F4FF 100%);
  padding: 15px;
  border-radius: 20px;
  border: 3px solid var(--text-dark);
  box-shadow: 4px 4px 0 var(--text-dark);
  transition: all 0.3s ease;
}

.control-group:hover {
  transform: translateY(-5px) scale(1.05);
  box-shadow: 6px 6px 0 var(--text-dark);
}

.control-group label {
  display: block;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 8px;
  color: var(--text-dark);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.control-group input[type="range"] {
  width: 100%;
  height: 12px;
  border-radius: 10px;
  background: linear-gradient(to right, var(--accent-pink), var(--accent-purple));
  outline: none;
  border: 2px solid var(--text-dark);
  -webkit-appearance: none;
  cursor: pointer;
}

.control-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--accent-yellow);
  border: 4px solid var(--text-dark);
  cursor: grab;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.control-group input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  background: var(--accent-orange);
}

.control-group input[type="range"]::-webkit-slider-thumb:active {
  cursor: grabbing;
  transform: scale(1.1);
}

.control-group input[type="range"]::-moz-range-thumb {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--accent-yellow);
  border: 4px solid var(--text-dark);
  cursor: grab;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.control-group input[type="range"]::-moz-range-thumb:hover {
  transform: scale(1.2);
  background: var(--accent-orange);
}

.value-display {
  display: inline-block;
  margin-top: 8px;
  padding: 6px 14px;
  background: var(--accent-yellow);
  border-radius: 15px;
  border: 3px solid var(--text-dark);
  font-weight: 700;
  font-size: 18px;
  color: var(--text-dark);
  box-shadow: 3px 3px 0 var(--text-dark);
  min-width: 60px;
}

.timer-display {
  background: linear-gradient(135deg, #FFFFFF 0%, #E8F5E9 100%);
  padding: 15px;
  border-radius: 20px;
  border: 3px solid var(--text-dark);
  box-shadow: 4px 4px 0 var(--text-dark);
  text-align: center;
  font-weight: 600;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.timer-display .label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 5px;
}

.timer-display .time {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent-purple);
}

#restartBtn {
  background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-pink) 100%);
  border: 4px solid var(--text-dark);
  border-radius: 20px;
  padding: 15px 20px;
  font-size: 32px;
  cursor: pointer;
  box-shadow: 4px 4px 0 var(--text-dark);
  transition: all 0.2s;
  font-family: 'Fredoka', cursive;
  color: white;
  font-weight: 700;
  text-shadow: 2px 2px 0 var(--text-dark);
}

#restartBtn:hover {
  transform: translateY(-4px) rotate(180deg) scale(1.1);
  box-shadow: 6px 6px 0 var(--text-dark);
}

#restartBtn:active {
  transform: translateY(-2px) rotate(180deg) scale(1.05);
  box-shadow: 3px 3px 0 var(--text-dark);
}

.canvas-wrapper {
  position: relative;
  display: inline-block;
  margin-top: 20px;
  animation: slideIn 0.6s ease-out 0.5s both;
}

canvas {
  background: linear-gradient(180deg, #B4E7FF 0%, #E0BBE4 100%);
  border-radius: 30px;
  border: 6px solid var(--text-dark);
  box-shadow:
    0 0 0 8px var(--accent-yellow),
    0 0 0 12px var(--text-dark),
    0 15px 30px rgba(0,0,0,0.3);
  display: block;
}

@keyframes wiggle {
  0%, 100% { transform: rotate(-1deg); }
  50% { transform: rotate(1deg); }
}

.fun-badge {
  position: absolute;
  top: -15px;
  right: -15px;
  background: var(--accent-yellow);
  border: 4px solid var(--text-dark);
  border-radius: 50%;
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  box-shadow: 4px 4px 0 var(--text-dark);
  animation: spin 10s linear infinite, pulse 2s ease-in-out infinite;
  z-index: 10;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.1) rotate(180deg); }
}

.floating-particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
}

.particle {
  position: absolute;
  font-size: 24px;
  animation: float 15s infinite ease-in-out;
  opacity: 0.6;
}

.particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 12s; }
.particle:nth-child(2) { left: 20%; animation-delay: 2s; animation-duration: 15s; }
.particle:nth-child(3) { left: 30%; animation-delay: 4s; animation-duration: 13s; }
.particle:nth-child(4) { left: 70%; animation-delay: 1s; animation-duration: 14s; }
.particle:nth-child(5) { left: 80%; animation-delay: 3s; animation-duration: 16s; }
.particle:nth-child(6) { left: 90%; animation-delay: 5s; animation-duration: 11s; }

@keyframes float {
  0%, 100% {
    transform: translateY(100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 0.6;
  }
  90% {
    opacity: 0.6;
  }
  100% {
    transform: translateY(-100px) rotate(360deg);
    opacity: 0;
  }
}

</style>
</head>

<body>
<div class="floating-particles">
  <div class="particle">ü¶†</div>
  <div class="particle">üß¨</div>
  <div class="particle">‚öóÔ∏è</div>
  <div class="particle">üî¨</div>
  <div class="particle">üß™</div>
  <div class="particle">üíß</div>
</div>

<div class="container">
<h1>ü¶† SUPER BACTERIA LAB! üß™</h1>
<div class="subtitle">Watch tiny heroes clean up plastic waste!</div>

<div class="legend">
  <div>üü¢ Bacteria Swarm</div>
  <div>üü£ Enzymes</div>
  <div>üî∑ Plastic: <span id="plasticCount"></span></div>
  <div>üí™ Remaining: <span id="plasticRemaining"></span>%</div>
</div>

<div class="controls">
  <div class="control-group">
    <label>ü¶† Bacteria Count</label>
    <input type="range" id="bacteriaSlider" min="4" max="40" value="14">
    <div class="value-display"><span id="bacteriaVal">14</span></div>
  </div>

  <div class="control-group">
    <label>üî∑ Plastic Pieces</label>
    <input type="range" id="plasticSlider" min="6" max="50" value="24">
    <div class="value-display"><span id="plasticVal">24</span></div>
  </div>

  <div class="control-group">
    <label>üå°Ô∏è Temperature (¬∞C)</label>
    <input type="range" id="tempSlider" min="0" max="75" value="25">
    <div class="value-display"><span id="tempVal">25</span>¬∞C</div>
  </div>

  <div class="control-group">
    <label>üíß Moisture Level</label>
    <input type="range" id="moistureSlider" min="0" max="1" step="0.1" value="0.5">
    <div class="value-display"><span id="moistureVal">0.5</span></div>
  </div>

  <div class="timer-display">
    <div class="label">‚è±Ô∏è Elapsed Time</div>
    <div class="time"><span id="elapsedTime">0 d 0 h</span></div>
  </div>

  <button id="restartBtn" type="button" aria-label="Restart simulation" title="Restart simulation">üîÑ</button>
</div>

<div class="canvas-wrapper">
  <div class="fun-badge">üî¨</div>
  <canvas id="scene" width="850" height="420"></canvas>
</div>
</div>

<script>
const canvas = document.getElementById("scene");
const ctx = canvas.getContext("2d");

const plasticCountEl = document.getElementById("plasticCount");
const plasticRemainingEl = document.getElementById("plasticRemaining");
const bacteriaSlider = document.getElementById("bacteriaSlider");
const plasticSlider = document.getElementById("plasticSlider");
const bacteriaVal = document.getElementById("bacteriaVal");
const plasticVal = document.getElementById("plasticVal");
const tempSlider = document.getElementById("tempSlider");
const tempVal = document.getElementById("tempVal");
const moistureSlider = document.getElementById("moistureSlider");
const moistureVal = document.getElementById("moistureVal");
const elapsedTimeEl = document.getElementById("elapsedTime");
const restartBtn = document.getElementById("restartBtn");

const groundY = 300;
const plastics = [];
const bacteriaSwarm = [];
const enzymes = [];
let enzymeCooldown = 0;
let lastTimestamp = 0;
let secondAccumulator = 0;
let simulationActive = true;
let timerStarted = false;
let elapsedStart = 0;
const secondDurationMs = 1000;

function rand(min, max) {
  return min + Math.random() * (max - min);
}

function createPlastics() {
  plastics.length = 0;
  const totalPlasticPieces = Number(plasticSlider.value);
  for (let i = 0; i < totalPlasticPieces; i++) {
    const x = rand(90, canvas.width - 90);
    const y = rand(groundY - 60, groundY + 40);
    const size = rand(18, 36);
    plastics.push({
      x,
      y,
      size,
      integrity: 100,
      wobble: rand(0, Math.PI * 2)
    });
  }
}

function createBacteria() {
  bacteriaSwarm.length = 0;
  const bacteriaCount = Number(bacteriaSlider.value);
  for (let i = 0; i < bacteriaCount; i++) {
    bacteriaSwarm.push({
      x: rand(80, canvas.width - 80),
      y: rand(80, groundY - 40),
      radius: rand(6, 10),
      speed: rand(0.6, 1.2),
      wiggle: rand(0, Math.PI * 2)
    });
  }
}

function tempFactor() {
  const tempC = Number(tempSlider.value);
  if (tempC < 5 || tempC > 70) {
    return 0;
  }
  return 0.5 + (tempC / 75);
}

function moistureFactor() {
  return Number(moistureSlider.value);
}

function nearestPlastic(b) {
  let closest = null;
  let closestDist = Infinity;
  for (const p of plastics) {
    if (p.integrity <= 0) continue;
    const dx = p.x - b.x;
    const dy = p.y - b.y;
    const dist = Math.hypot(dx, dy);
    if (dist < closestDist) {
      closestDist = dist;
      closest = p;
    }
  }
  return { target: closest, dist: closestDist };
}

function spawnEnzymes() {
  if (tempFactor() === 0) {
    return;
  }
  if (enzymeCooldown > 0) {
    enzymeCooldown -= 1;
    return;
  }
  for (const b of bacteriaSwarm) {
    if (Math.random() < 0.35) {
      enzymes.push({
        x: b.x,
        y: b.y,
        radius: rand(3, 5),
        speed: rand(1.2, 2.2),
        life: rand(140, 220),
        drift: rand(0, Math.PI * 2)
      });
    }
  }
  enzymeCooldown = 10;
}

function updateEnzymes() {
  const factor = tempFactor();
  const moisture = moistureFactor();
  for (const e of enzymes) {
    const { target } = nearestPlastic(e);
    if (target) {
      const dx = target.x - e.x;
      const dy = target.y - e.y;
      const angle = Math.atan2(dy, dx);
      const step = e.speed * factor * moisture;
      e.x += Math.cos(angle) * step;
      e.y += Math.sin(angle) * step;

      if (Math.hypot(dx, dy) < e.radius + target.size * 0.35) {
        target.integrity = Math.max(0, target.integrity - 0.6 * factor * moisture);
        e.life -= 40;
      }
    } else {
      e.drift += 0.2;
      e.x += Math.cos(e.drift) * 0.6;
      e.y += Math.sin(e.drift) * 0.6;
    }
    e.life -= 1;
  }
  for (let i = enzymes.length - 1; i >= 0; i--) {
    if (enzymes[i].life <= 0) enzymes.splice(i, 1);
  }
}

function updateBacteria() {
  const factor = tempFactor();
  const moisture = moistureFactor();
  for (const b of bacteriaSwarm) {
    const { target, dist } = nearestPlastic(b);
    if (target) {
      const dx = target.x - b.x;
      const dy = target.y - b.y;
      const angle = Math.atan2(dy, dx);
      const step = b.speed * factor * moisture;
      b.x += Math.cos(angle) * step;
      b.y += Math.sin(angle) * step;
    }

    b.wiggle += 0.1;
    b.y += Math.sin(b.wiggle) * 0.3;
  }
}

function drawBackground() {
  // Sky with fun gradient
  const sky = ctx.createLinearGradient(0, 0, 0, groundY);
  sky.addColorStop(0, "#B4E7FF");
  sky.addColorStop(0.5, "#E0BBE4");
  sky.addColorStop(1, "#FFD6E8");
  ctx.fillStyle = sky;
  ctx.fillRect(0, 0, canvas.width, groundY);

  // Add floating bubbles in background
  ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
  for (let i = 0; i < 15; i++) {
    const x = (i * 60 + Date.now() * 0.01) % canvas.width;
    const y = (i * 40 + Math.sin(Date.now() * 0.001 + i) * 30) % groundY;
    const size = 8 + (i % 3) * 4;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }

  // Landfill mound with cartoon style
  const mound = ctx.createLinearGradient(0, groundY - 80, 0, canvas.height);
  mound.addColorStop(0, "#8B7355");
  mound.addColorStop(0.5, "#6B5444");
  mound.addColorStop(1, "#4A3B2F");
  ctx.fillStyle = mound;

  // Outline first (comic book style)
  ctx.strokeStyle = "#2D1B13";
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(0, groundY);
  ctx.bezierCurveTo(140, groundY - 90, 320, groundY - 40, 520, groundY - 70);
  ctx.bezierCurveTo(650, groundY - 90, 760, groundY - 10, canvas.width, groundY - 40);
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.closePath();
  ctx.stroke();
  ctx.fill();

  // Add texture spots
  ctx.fillStyle = "rgba(0, 0, 0, 0.15)";
  for (let i = 0; i < 20; i++) {
    const x = Math.random() * canvas.width;
    const y = groundY + Math.random() * (canvas.height - groundY);
    const size = 3 + Math.random() * 8;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }
}

function drawPlastics() {
  for (const p of plastics) {
    if (p.integrity <= 0) continue;
    const size = p.size * (0.4 + p.integrity / 200);
    const alpha = Math.max(0.2, p.integrity / 100);
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(Math.sin(p.wobble) * 0.3);

    // Cartoon outline
    ctx.strokeStyle = `rgba(14, 76, 100, ${alpha})`;
    ctx.lineWidth = 4;
    drawRoundedRect(-size / 2, -size / 3, size, size / 1.6, 8);
    ctx.stroke();

    // Gradient fill
    const gradient = ctx.createLinearGradient(-size/2, -size/3, size/2, size/1.6);
    gradient.addColorStop(0, `rgba(76, 201, 240, ${alpha})`);
    gradient.addColorStop(0.5, `rgba(56, 189, 248, ${alpha})`);
    gradient.addColorStop(1, `rgba(30, 170, 230, ${alpha})`);
    ctx.fillStyle = gradient;
    drawRoundedRect(-size / 2, -size / 3, size, size / 1.6, 8);
    ctx.fill();

    // Shine effect
    ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.5})`;
    ctx.beginPath();
    ctx.ellipse(-size / 4, -size / 6, size / 6, size / 10, -0.3, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
    p.wobble += 0.02;
  }
}

function drawRoundedRect(x, y, width, height, radius) {
  const r = Math.min(radius, width / 2, height / 2);
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + width - r, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + r);
  ctx.lineTo(x + width, y + height - r);
  ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
  ctx.lineTo(x + r, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function drawEnzymes() {
  const dormant = tempFactor() === 0;
  for (const e of enzymes) {
    ctx.save();
    ctx.translate(e.x, e.y);

    // Glow effect
    if (!dormant) {
      const glow = ctx.createRadialGradient(0, 0, 0, 0, 0, e.radius * 2);
      glow.addColorStop(0, "rgba(168, 85, 247, 0.4)");
      glow.addColorStop(1, "rgba(168, 85, 247, 0)");
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(0, 0, e.radius * 2, 0, Math.PI * 2);
      ctx.fill();
    }

    // Main body with gradient
    const gradient = ctx.createRadialGradient(-e.radius/3, -e.radius/3, 0, 0, 0, e.radius);
    if (dormant) {
      gradient.addColorStop(0, "rgba(180, 190, 200, 0.9)");
      gradient.addColorStop(1, "rgba(120, 130, 150, 0.7)");
    } else {
      gradient.addColorStop(0, "rgba(200, 120, 255, 0.9)");
      gradient.addColorStop(1, "rgba(140, 60, 220, 0.8)");
    }
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(0, 0, e.radius, 0, Math.PI * 2);
    ctx.fill();

    // Cartoon outline
    ctx.strokeStyle = dormant ? "rgba(70, 80, 100, 1)" : "rgba(100, 30, 180, 1)";
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.arc(0, 0, e.radius, 0, Math.PI * 2);
    ctx.stroke();

    // Sparkle
    if (!dormant) {
      ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
      ctx.beginPath();
      ctx.arc(-e.radius/3, -e.radius/3, e.radius/4, 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.restore();
  }
}

function drawBacteria() {
  const dormant = tempFactor() === 0;
  for (const b of bacteriaSwarm) {
    ctx.save();
    ctx.translate(b.x, b.y);

    // Flagella (cartoon wiggly tails)
    ctx.strokeStyle = dormant ? "rgba(120, 140, 160, 0.8)" : "rgba(30, 200, 100, 0.9)";
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    for (let i = 0; i < 4; i++) {
      const angle = (i / 4) * Math.PI * 2 + b.wiggle * 0.2;
      ctx.beginPath();
      ctx.moveTo(Math.cos(angle) * b.radius * 0.6, Math.sin(angle) * b.radius * 0.4);

      // Wavy flagella
      const segments = 3;
      for (let s = 1; s <= segments; s++) {
        const dist = (b.radius * 1.6 / segments) * s;
        const wave = Math.sin(b.wiggle + s) * 4;
        const px = Math.cos(angle) * dist + Math.cos(angle + Math.PI/2) * wave;
        const py = Math.sin(angle) * dist * 0.7 + Math.sin(angle + Math.PI/2) * wave;
        ctx.lineTo(px, py);
      }
      ctx.stroke();
    }

    // Main body with gradient
    const gradient = ctx.createRadialGradient(-b.radius/2, -b.radius/2, 0, 0, 0, b.radius * 1.5);
    if (dormant) {
      gradient.addColorStop(0, "#B4C4D8");
      gradient.addColorStop(1, "#7A8AA0");
    } else {
      gradient.addColorStop(0, "#4ADE80");
      gradient.addColorStop(1, "#16A34A");
    }
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.ellipse(0, 0, b.radius * 1.2, b.radius * 0.9, 0, 0, Math.PI * 2);
    ctx.fill();

    // Cartoon outline
    ctx.strokeStyle = dormant ? "#506070" : "#0F7A2F";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.ellipse(0, 0, b.radius * 1.2, b.radius * 0.9, 0, 0, Math.PI * 2);
    ctx.stroke();

    // Eyes (cute!)
    ctx.fillStyle = dormant ? "#506070" : "#0F7A2F";
    ctx.beginPath();
    ctx.arc(-b.radius * 0.4, -b.radius * 0.2, b.radius * 0.2, 0, Math.PI * 2);
    ctx.arc(b.radius * 0.4, -b.radius * 0.2, b.radius * 0.2, 0, Math.PI * 2);
    ctx.fill();

    // Eye shine
    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
    ctx.beginPath();
    ctx.arc(-b.radius * 0.4 - b.radius * 0.08, -b.radius * 0.25, b.radius * 0.08, 0, Math.PI * 2);
    ctx.arc(b.radius * 0.4 - b.radius * 0.08, -b.radius * 0.25, b.radius * 0.08, 0, Math.PI * 2);
    ctx.fill();

    // Happy mouth
    if (!dormant) {
      ctx.strokeStyle = "#0F7A2F";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(0, b.radius * 0.1, b.radius * 0.5, 0.2, Math.PI - 0.2);
      ctx.stroke();
    }

    // Highlight
    ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
    ctx.beginPath();
    ctx.ellipse(-b.radius * 0.3, -b.radius * 0.3, b.radius * 0.5, b.radius * 0.3, -0.5, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
  }
}

function updateStats() {
  const remainingPieces = plastics.filter(p => p.integrity > 0).length;
  const totalIntegrity = plastics.reduce((sum, p) => sum + p.integrity, 0);
  const totalPlasticPieces = Number(plasticSlider.value);
  const percent = totalPlasticPieces === 0
    ? 0
    : Math.max(0, Math.round((totalIntegrity / (totalPlasticPieces * 100)) * 100));
  plasticCountEl.textContent = remainingPieces;
  plasticRemainingEl.textContent = percent;
  return percent;
}

function drawScene() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawPlastics();
  drawEnzymes();
  drawBacteria();

  // Victory message when all plastic is gone
  const remainingPieces = plastics.filter(p => p.integrity > 0).length;
  if (remainingPieces === 0 && plastics.length > 0) {
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // Celebration text
    ctx.font = "bold 48px 'Fredoka'";
    ctx.fillStyle = "#FFD60A";
    ctx.strokeStyle = "#2D1B69";
    ctx.lineWidth = 8;
    ctx.strokeText("üéâ ALL CLEAN! üéâ", canvas.width / 2, canvas.height / 2 - 30);
    ctx.fillText("üéâ ALL CLEAN! üéâ", canvas.width / 2, canvas.height / 2 - 30);

    ctx.font = "bold 28px 'Fredoka'";
    ctx.fillStyle = "#FF6BB5";
    ctx.strokeStyle = "#2D1B69";
    ctx.lineWidth = 6;
    ctx.strokeText("BACTERIA WIN!", canvas.width / 2, canvas.height / 2 + 20);
    ctx.fillText("BACTERIA WIN!", canvas.width / 2, canvas.height / 2 + 20);

    ctx.restore();
  }
}

function updateTimer(timestamp, remainingPercent) {
  if (!simulationActive) return;
  if (!timerStarted && remainingPercent === 100) {
    timerStarted = true;
    lastTimestamp = timestamp;
    elapsedStart = timestamp;
  }
  if (!timerStarted) return;
  if (remainingPercent <= 0) {
    simulationActive = false;
    return;
  }
  if (!lastTimestamp) lastTimestamp = timestamp;
  const delta = timestamp - lastTimestamp;
  lastTimestamp = timestamp;
  secondAccumulator += delta;
  while (secondAccumulator >= secondDurationMs) {
    secondAccumulator -= secondDurationMs;
  }
  const elapsedDays = (timestamp - elapsedStart) / 1000;
  const wholeDays = Math.floor(elapsedDays);
  const hours = Math.floor((elapsedDays - wholeDays) * 24);
  elapsedTimeEl.textContent = `${wholeDays} d ${hours} h`;
}

function loop(timestamp) {
  if (!timerStarted) {
    drawScene();
    const remainingPercent = updateStats();
    updateTimer(timestamp, remainingPercent);
    requestAnimationFrame(loop);
    return;
  }
  if (simulationActive) {
    spawnEnzymes();
    updateBacteria();
    updateEnzymes();
  }
  drawScene();
  const remainingPercent = updateStats();
  updateTimer(timestamp, remainingPercent);
  requestAnimationFrame(loop);
}

function updateCounts() {
  bacteriaVal.textContent = bacteriaSlider.value;
  plasticVal.textContent = plasticSlider.value;
  tempVal.textContent = tempSlider.value;
  moistureVal.textContent = moistureSlider.value;
}

function resetSimulation() {
  createPlastics();
  createBacteria();
  enzymes.length = 0;
  enzymeCooldown = 0;
  secondAccumulator = 0;
  lastTimestamp = 0;
  simulationActive = true;
  timerStarted = false;
  elapsedStart = 0;
  elapsedTimeEl.textContent = "0 d 0 h";
}

bacteriaSlider.addEventListener("input", () => {
  updateCounts();
  createBacteria();
});

plasticSlider.addEventListener("input", () => {
  updateCounts();
  resetSimulation();
});

tempSlider.addEventListener("input", () => {
  updateCounts();
});

moistureSlider.addEventListener("input", () => {
  updateCounts();
});

updateCounts();
resetSimulation();
loop();

restartBtn.addEventListener("click", () => {
  resetSimulation();
});
</script>
</body>
</html>
